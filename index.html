<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- PWA / Tema rengi eklemeleri -->
    <meta name="theme-color" content="#2c3e50">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="application-name" content="Kasa Takip">
    <meta name="apple-mobile-web-app-title" content="Kasa Takip">
    <title>Kasa Takip (Fix SÃ¼rÃ¼m)</title>
    <style>
        :root { --dark: #2c3e50; --blue: #007AFF; --green: #34C759; --red: #FF3B30; --orange: #FF9500; --bg: #F2F2F7; --active-tab: #007AFF; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: var(--bg); 
            margin: 0; 
            padding: 15px; 
            padding-top: env(safe-area-inset-top);
            color: #333; 
            padding-bottom: 50px; 
        }
        
        /* Layout */
        .grid-container { display: grid; grid-template-columns: 1fr 350px; gap: 15px; max-width: 1200px; margin: 0 auto; }
        .full-width { grid-column: 1 / -1; }
        
        /* Kartlar */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); margin-bottom: 15px; }
        .card-header { font-weight: 600; font-size: 1.1em; color: var(--dark); border-bottom: 1px solid #e5e5ea; padding-bottom: 10px; margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; gap: 6px; flex-wrap: wrap; }
        
        /* Ã–ZET KARTI */
        .summary-card {
            background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
            color: white;
            border-radius: 16px;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
        }
        .sum-item { text-align: center; flex: 1; border-right: 1px solid rgba(255,255,255,0.2); }
        .sum-item:last-child { border-right: none; }
        .sum-label { font-size: 0.75em; opacity: 0.8; display: block; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .sum-val { font-size: 1.1em; font-weight: 700; display: block; letter-spacing: -0.5px; }

        /* KASA SEÃ‡Ä°CÄ° */
        .portfolio-tabs { display: flex; background: white; padding: 5px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .tab-btn { flex: 1; border: none; background: transparent; padding: 10px; font-size: 0.95em; font-weight: 600; color: #8e8e93; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .tab-btn.active { background: var(--active-tab); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.15); }
        
        /* Inputlar */
        .settings-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
        .input-group label { display: block; font-size: 0.8em; font-weight: 600; color: #8e8e93; margin-bottom: 5px; }
        .input-group input { 
            width: 100%; padding: 12px; border: 1px solid #c7c7cc; border-radius: 8px; 
            font-size: 16px; font-weight: 600; box-sizing: border-box; background: white;
            -webkit-appearance: none;
        }
        .input-group input:focus { border-color: var(--blue); outline: none; }

        /* Dashboard */
        .dashboard-stats { 
            display: grid; 
            grid-template-columns: repeat(6, 1fr); /* 5'ten 6'ya Ã§Ä±ktÄ± (Ä°sabet OranÄ± eklendi) */
            gap: 4px; 
            background: white; 
            border-radius: 12px; 
            padding: 10px; 
            margin-bottom: 15px; 
            border: 1px solid #e5e5ea; 
        }
        .stat-box { text-align: center; }
        .stat-val { font-size: 1.05em; font-weight: bold; display: block; color: var(--dark); letter-spacing: -0.5px; }
        .stat-label { font-size: 0.6em; color: #8e8e93; font-weight: 600; white-space: nowrap; }

        /* Plan Tablosu */
        .plan-table { width: 100%; border-collapse: collapse; font-size: 0.85em; }
        .plan-table th { text-align: left; color: #8e8e93; border-bottom: 1px solid #c6c6c8; padding: 8px 4px; font-weight: 500; }
        .plan-table td { padding: 10px 4px; border-bottom: 1px solid #efeff4; font-variant-numeric: tabular-nums; }
        .current-row { background-color: #e3f2fd; font-weight: 600; color: var(--blue); }

        /* Aktif Bahis AlanÄ± */
        .bet-area { background: #fff; border: 2px solid var(--blue); padding: 20px; border-radius: 14px; text-align: center; margin-bottom: 15px; }
        .step-title { font-size: 1.2em; font-weight: 800; color: var(--blue); margin: 0 0 10px 0; letter-spacing: -0.5px; }

        /* Butonlar */
        .btn-save { 
            width: 100%; padding: 15px; border: none; border-radius: 10px; cursor: pointer; color: white; 
            font-weight: 700; font-size: 1.1em; margin-top: 15px;
            background: linear-gradient(to right, #007AFF, #0056b3);
            box-shadow: 0 4px 10px rgba(0, 122, 255, 0.3);
            transition: transform 0.1s;
        }
        .btn-save:active { transform: scale(0.98); }
        .btn-reset { background: #8e8e93; font-size: 0.8em; padding: 5px 10px; border-radius: 6px; color: white; border: none; cursor: pointer; }

        /* GeÃ§miÅŸ Tablosu */
        .history-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 0.85em; min-width: 100%; }
        .history-table th { background: #f2f2f7; padding: 10px 4px; text-align: center; color: #8e8e93; font-weight: 600; white-space: nowrap; }
        .history-table td { padding: 12px 4px; text-align: center; border-bottom: 1px solid #e5e5ea; vertical-align: middle; }
        
        .action-btn { padding: 6px 10px; border: none; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; margin: 0 2px; font-size: 0.85em; }
        .btn-check { background: var(--green); }
        .btn-cross { background: var(--red); }
        .btn-undo { background: var(--orange); }
        .btn-del { background: #8e8e93; opacity: 0.5; }

        .status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.8em; font-weight: bold; display: inline-block; min-width: 60px; }
        .st-pending { background: #fff3cd; color: #856404; }
        .st-win { background: #d4edda; color: #155724; }
        .st-loss { background: #f8d7da; color: #721c24; }

        @media (max-width: 800px) { 
            .grid-container { grid-template-columns: 1fr; } 
            .summary-card { flex-wrap: wrap; gap: 10px; }
            .sum-item { flex: 1 1 40%; border-right: none; }
            .stat-val { font-size: 0.9em; } 
            .dashboard-stats { gap: 2px; }
        }
    </style>
</head>
<body>

<div class="grid-container">
    
    <div class="full-width">
        <div class="summary-card">
            <div class="sum-item">
                <span class="sum-label">BaÅŸlangÄ±Ã§</span>
                <span class="sum-val" id="sumStart">0,00 TL</span>
            </div>
            <div class="sum-item">
                <span class="sum-label">Son Kasa</span>
                <span class="sum-val" id="sumEnd">0,00 TL</span>
            </div>
            <div class="sum-item">
                <span class="sum-label">Net KÃ¢r</span>
                <span class="sum-val" id="sumProfit">0,00 TL</span>
            </div>
            <div class="sum-item">
                <span class="sum-label">BÃ¼yÃ¼me</span>
                <span class="sum-val" id="sumPercent">%0,00</span>
            </div>
        </div>

        <div class="portfolio-tabs">
            <button class="tab-btn active" id="tab0" onclick="switchKasa(0)">KASA 1</button>
            <button class="tab-btn" id="tab1" onclick="switchKasa(1)">KASA 2</button>
            <button class="tab-btn" id="tab2" onclick="switchKasa(2)">KASA 3</button>
        </div>
    </div>

    <div class="full-width">
        <div class="card">
            <div class="card-header">
                <span id="settingsTitle">Ayarlar (Kasa 1)</span>
                <div style="display:flex; gap:6px; flex-wrap:wrap;">
                    <button class="btn-reset" onclick="hardReset()">Bu KasayÄ± SÄ±fÄ±rla</button>
                    <button class="btn-reset" onclick="resetAllKasas()">TÃ¼m KasalarÄ± SÄ±fÄ±rla</button>
                </div>
            </div>
            <div class="settings-grid">
                <div class="input-group">
                    <label>Kasa (TL)</label>
                    <input type="number" id="currentBalance" inputmode="decimal" onchange="updateData()" onkeyup="scheduleUpdate()">
                </div>
                <div class="input-group">
                    <label>Plan OranÄ±</label>
                    <input type="number" id="planOdds" value="2.00" step="0.01" inputmode="decimal" onchange="updateData()" onkeyup="scheduleUpdate()">
                </div>
                <div class="input-group">
                    <label>Tur (AdÄ±m)</label>
                    <input type="number" id="totalSteps" value="4" inputmode="numeric" onchange="updateData()" onkeyup="scheduleUpdate()">
                </div>
                <div class="input-group">
                    <label>Hedef Kupon</label>
                    <input type="number" id="targetWins" value="10" inputmode="numeric" onchange="updateData()" onkeyup="scheduleUpdate()">
                </div>
            </div>
        </div>

        <div class="dashboard-stats">
            <div class="stat-box">
                <span class="stat-val" id="dispRemaining">0</span>
                <span class="stat-label">Kalan Kupon</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="dispWon" style="color: var(--green);">0</span>
                <span class="stat-label">Tutturulan</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="dispLost" style="color: var(--red);">0</span>
                <span class="stat-label">Kaybedilen</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="dispAvgOdds">0,00</span>
                <span class="stat-label">Ort. Kazanan Oran</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="dispHitRate">-%</span>
                <span class="stat-label">Ä°sabet OranÄ±</span>
            </div>
            <div class="stat-box">
                <span class="stat-val" id="dispProjected" style="color: #f1c40f;">-</span>
                <span class="stat-label">Tahmini (Min / Ort / Max)</span>
            </div>
        </div>
    </div>

    <div>
        <div class="bet-area">
            <div class="step-title" id="stepIndicator">ADIM 1</div>
            <p style="font-size:0.8em; color:#8e8e93; margin-top:-5px; margin-bottom:15px;">Ã–nce kuponu oluÅŸtur, sonra aÅŸaÄŸÄ±dan sonucunu gir.</p>
            
            <div class="settings-grid">
                <div class="input-group">
                    <label>Oynanan Tutar</label>
                    <input type="number" id="betAmount" inputmode="decimal">
                </div>
                <div class="input-group">
                    <label>Kupon OranÄ±</label>
                    <input type="number" id="betOdds" step="0.01" inputmode="decimal">
                </div>
            </div>
            
            <button class="btn-save" onclick="saveCoupon()">Kuponu Kaydet (Bekliyor)</button>
        </div>

        <div class="card">
            <div class="card-header">Kupon GeÃ§miÅŸi</div>
            <div style="overflow-x: auto;">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>AdÄ±m</th>
                            <th>Tutar</th>
                            <th>Oran</th>
                            <th>OlasÄ± K.</th>
                            <th>Durum/Ä°ÅŸlem</th>
                            <th>Sil</th>
                        </tr>
                    </thead>
                    <tbody id="historyBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div>
        <div class="card">
            <div class="card-header">
                CanlÄ± Plan
            </div>
            <p style="font-size: 0.75em; color: #8e8e93; margin-top:-10px;">
                Plan BazÄ±: <b><span id="planBaseRef"></span></b> <br>
                Hesaplanan DÃ¶ngÃ¼: <b><span id="planStepRef"></span> Tur</b>
            </p>
            <table class="plan-table">
                <thead>
                    <tr>
                        <th>Tur</th>
                        <th>YatÄ±rÄ±lacak</th>
                        <th>OlasÄ± KazanÃ§</th>
                    </tr>
                </thead>
                <tbody id="planBody"></tbody>
            </table>
        </div>
    </div>

</div>

<script>
    // --- YARDIMCI FORMAT FONKSÄ°YONLARI ---
    const fmtMoney = (num) =>
        new Intl.NumberFormat("tr-TR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(num) + " TL";

    const fmtNum = (num) =>
        new Intl.NumberFormat("tr-TR", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
        }).format(num);

    // --- VERÄ° YAPISI ---
    let globalState = {
        activeIndex: 0,
        portfolios: [
            { history: [], savedInputs: null },
            { history: [], savedInputs: null },
            { history: [], savedInputs: null },
        ],
    };
    let app = null;

    // --- DEBOUNCE (2.3) ---
    let updateTimeout = null;
    function scheduleUpdate() {
        clearTimeout(updateTimeout);
        updateTimeout = setTimeout(updateData, 120);
    }

    // --- BAÅžLANGIÃ‡ (localStorage gÃ¼venli okuma) ---
    window.onload = function () {
        try {
            const savedData = localStorage.getItem("kasaV14_fixedMath");
            if (savedData) {
                const parsed = JSON.parse(savedData);
                if (parsed && Array.isArray(parsed.portfolios)) {
                    globalState = parsed;
                }
            }
        } catch (e) {
            console.warn("KayÄ±tlÄ± veri okunamadÄ±, sÄ±fÄ±rdan baÅŸlatÄ±lÄ±yor.", e);
            globalState = {
                activeIndex: 0,
                portfolios: [
                    { history: [], savedInputs: null },
                    { history: [], savedInputs: null },
                    { history: [], savedInputs: null },
                ],
            };
        }

        if (typeof globalState.activeIndex !== "number") {
            globalState.activeIndex = 0;
        }

        switchKasa(globalState.activeIndex);
    };

    // --- KASA / PORTFÃ–Y DEÄžÄ°ÅžTÄ°RME ---
    function switchKasa(index) {
        document.querySelectorAll(".tab-btn").forEach((btn, i) => {
            if (i === index) btn.classList.add("active");
            else btn.classList.remove("active");
        });

        globalState.activeIndex = index;
        app = globalState.portfolios[index];

        document.getElementById("settingsTitle").innerText =
            `Ayarlar (Kasa ${index + 1})`;

        const balanceInput = document.getElementById("currentBalance");
        const planOddsInput = document.getElementById("planOdds");
        const totalStepsInput = document.getElementById("totalSteps");
        const targetWinsInput = document.getElementById("targetWins");

        if (app.savedInputs) {
            balanceInput.value = app.savedInputs.balance;
            planOddsInput.value = app.savedInputs.odds;
            totalStepsInput.value = app.savedInputs.steps;
            targetWinsInput.value = app.savedInputs.target;
        } else {
            balanceInput.value = 5000;
            planOddsInput.value = 2.0;
            totalStepsInput.value = 4;
            targetWinsInput.value = 10;
        }

        updateData();
    }

    // --- ADIM HESAPLAMA (DÃœZELTÄ°LMÄ°Åž) ---
    function calculateCurrentStep(history, maxSteps) {
        const finished = history.filter((h) => h.status !== "pending");
        if (finished.length === 0) return 1;

        const lastFinished = finished[0];

        // Son biten kupon kazandÄ±ysa dÃ¶ngÃ¼ reset
        if (lastFinished.status === "win") {
            return 1;
        }

        // En yeni kayÄ±plarÄ± Ã¼st Ã¼ste say, ilk win'de kÄ±r
        let lossCount = 0;
        for (const h of finished) {
            if (h.status === "loss") lossCount++;
            else break;
        }

        let step = lossCount + 1;

        if (typeof maxSteps === "number" && maxSteps > 0) {
            step = Math.min(step, maxSteps + 1);
        }

        return step;
    }

    // --- PLAN OLUÅžTURMA HELPER (ortak) ---
    function buildPlan(cycleBalance, odds, totalSteps) {
        if (!cycleBalance || cycleBalance <= 0) return null;
        if (!totalSteps || totalSteps <= 0) return null;
        if (!odds || odds <= 1) return null;

        let weights = [];
        let currentWeightSum = 0;
        const growthFactor = odds / (odds - 1);

        weights.push(1);
        currentWeightSum += 1;

        for (let i = 1; i < totalSteps; i++) {
            const nextWeight = weights[i - 1] * growthFactor;
            weights.push(nextWeight);
            currentWeightSum += nextWeight;
        }

        const unitValue = cycleBalance / currentWeightSum;
        const planAmounts = weights.map((w) => w * unitValue);
        return planAmounts;
    }

    // --- ANA GÃœNCELLEME ---
    function updateData() {
        if (!app) return;

        const balance =
            parseFloat(document.getElementById("currentBalance").value) || 0;
        const odds =
            parseFloat(document.getElementById("planOdds").value) || 2.0;
        const steps =
            parseInt(document.getElementById("totalSteps").value) || 4;
        const target =
            parseInt(document.getElementById("targetWins").value) || 10;

        const history = app.history || [];
        const finishedBets = history.filter((h) => h.status !== "pending");
        const wins = finishedBets.filter((h) => h.status === "win").length;
        const losses = finishedBets.filter((h) => h.status === "loss").length;
        const totalWinOdds = finishedBets
            .filter((h) => h.status === "win")
            .reduce((sum, h) => sum + h.odds, 0);
        const avgOdds = wins > 0 ? totalWinOdds / wins : 0;

        // Toplam kupon sayÄ±sÄ± (bitmiÅŸ + bekleyen)
        const totalCoupons = history.length;
        const remainingCoupons = Math.max(0, target - totalCoupons);

        // Dashboard (Kalan Kupon / Tutturulan / Kaybedilen / Ort. Oran / Ä°sabet)
        document.getElementById("dispRemaining").innerText = remainingCoupons;
        document.getElementById("dispWon").innerText = wins;
        document.getElementById("dispLost").innerText = losses;
        document.getElementById("dispAvgOdds").innerText = fmtNum(avgOdds);

        const totalBets = wins + losses;
        let hitRateText = "-%";
        if (totalBets > 0) {
            const pHat = (wins / totalBets) * 100;
            hitRateText = fmtNum(pHat) + "%";
        }
        document.getElementById("dispHitRate").innerText = hitRateText;

        const currentStep = calculateCurrentStep(history, steps);

        const stepIndicator = document.getElementById("stepIndicator");
        stepIndicator.innerText = `ADIM ${Math.min(currentStep, steps)} / ${steps}`;
        stepIndicator.style.color =
            currentStep <= steps ? "var(--blue)" : "var(--red)";

        // --- PLAN / TAHMÄ°N EDGE CASE (Oran <= 1 vb.) ---
        const planBody = document.getElementById("planBody");
        const projEl = document.getElementById("dispProjected");

        const canPlan =
            balance > 0 && steps > 0 && odds > 1;

        if (!canPlan) {
            planBody.innerHTML = `
                <tr>
                    <td colspan="3" style="color:#e74c3c; font-size:0.8em;">
                        Plan oluÅŸturmak iÃ§in kasa &gt; 0 ve oran &gt; 1 olmalÄ±dÄ±r.
                    </td>
                </tr>`;
            document.getElementById("planBaseRef").innerText = "-";
            document.getElementById("planStepRef").innerText = "-";
            projEl.innerText = "-";

            // Ã–zet yine de hesaplansÄ±n
            calculateSummary(balance);
            renderHistory();
            app.savedInputs = { balance, odds, steps, target };
            save();
            return;
        }

        // --- DÃ–NGÃœ BAÅžLANGIÃ‡ BAKÄ°YESÄ° (Cycle Base) ---
        let cycleStartBalance = balance;
        for (let h of history) {
            if (h.status === "win") break;
            if (h.status === "pending" || h.status === "loss") {
                cycleStartBalance += h.amount;
            }
        }

        // Plan tablosu
        calculateAndRenderPlan(cycleStartBalance, odds, steps, currentStep);

        // Ã–zet (baÅŸlangÄ±Ã§, son kasa, net kÃ¢r, bÃ¼yÃ¼me)
        calculateSummary(balance);

        // Tahmini kasa (Min / Ort / Max)
        updateProjection({
            currentBalance: balance,
            cycleBalance: cycleStartBalance,
            odds,
            steps,
            currentStep,
            targetCoupons: target,
        });

        // InputlarÄ± bu kasaya kaydet
        app.savedInputs = { balance, odds, steps, target };
        save();

        document.getElementById("planBaseRef").innerText =
            fmtMoney(cycleStartBalance);
        document.getElementById("planStepRef").innerText = steps;

        renderHistory();
    }

    // --- KUPON Ä°ÅžLEMLERÄ° ---
    function saveCoupon() {
        const amount = parseFloat(
            document.getElementById("betAmount").value
        );
        const odds = parseFloat(document.getElementById("betOdds").value);
        let currentBalance = parseFloat(
            document.getElementById("currentBalance").value
        );
        const steps =
            parseInt(document.getElementById("totalSteps").value) || 4;

        const stepCalc = calculateCurrentStep(app.history || [], steps);

        if (!amount || !odds)
            return alert("LÃ¼tfen tutar ve oran girin.");

        currentBalance -= amount;
        document.getElementById("currentBalance").value =
            currentBalance.toFixed(2);

        app.history.unshift({
            id: Date.now(),
            step: stepCalc,
            amount: amount,
            odds: odds,
            status: "pending",
        });

        document.getElementById("betAmount").value = "";
        updateData();
    }

    function setResult(id, result) {
        const item = app.history.find((h) => h.id === id);
        if (!item) return;

        let currentBalance = parseFloat(
            document.getElementById("currentBalance").value
        );

        if (result === "win") {
            const winAmount = item.amount * item.odds;
            currentBalance += winAmount;
            item.status = "win";
        } else if (result === "loss") {
            item.status = "loss";
        }

        document.getElementById("currentBalance").value =
            currentBalance.toFixed(2);
        updateData();
    }

    function undoResult(id) {
        const item = app.history.find((h) => h.id === id);
        if (!item) return;

        let currentBalance = parseFloat(
            document.getElementById("currentBalance").value
        );

        if (item.status === "win") {
            currentBalance -= item.amount * item.odds;
        }

        item.status = "pending";
        document.getElementById("currentBalance").value =
            currentBalance.toFixed(2);
        updateData();
    }

    function deleteCoupon(id) {
        const itemIndex = app.history.findIndex((h) => h.id === id);
        if (itemIndex === -1) return;
        const item = app.history[itemIndex];

        if (
            !confirm(
                "Silmek istediÄŸinize emin misiniz? Bakiye dÃ¼zeltilecek."
            )
        )
            return;

        let currentBalance = parseFloat(
            document.getElementById("currentBalance").value
        );

        if (item.status === "pending") {
            currentBalance += item.amount;
        } else if (item.status === "loss") {
            currentBalance += item.amount;
        } else if (item.status === "win") {
            currentBalance =
                currentBalance - item.amount * item.odds + item.amount;
        }

        app.history.splice(itemIndex, 1);
        document.getElementById("currentBalance").value =
            currentBalance.toFixed(2);
        updateData();
    }

    // --- GEÃ‡MÄ°Åž TABLOSU ---
    function renderHistory() {
        const tbody = document.getElementById("historyBody");
        tbody.innerHTML = "";

        if (!app || !app.history) return;

        app.history.forEach((h) => {
            const grossReturn = h.amount * h.odds;
            let statusHtml = "";

            if (h.status === "pending") {
                statusHtml = `
                    <button class="action-btn btn-check" onclick="setResult(${h.id}, 'win')">âœ”</button>
                    <button class="action-btn btn-cross" onclick="setResult(${h.id}, 'loss')">âœ–</button>
                    <span style="font-size:0.75em; color:#999; display:block;">Bekliyor</span>
                `;
            } else if (h.status === "win") {
                statusHtml = `
                    <span class="status-badge st-win">KAZANDI</span>
                    <button class="action-btn btn-undo" onclick="undoResult(${h.id})" title="Geri Al">â†º</button>
                `;
            } else {
                statusHtml = `
                    <span class="status-badge st-loss">KAYBETTÄ°</span>
                    <button class="action-btn btn-undo" onclick="undoResult(${h.id})" title="Geri Al">â†º</button>
                `;
            }

            let returnColor = "#555";
            if (h.status === "win") returnColor = "var(--green)";

            const row = `
                <tr>
                    <td>${h.step}</td>
                    <td>${fmtMoney(h.amount)}</td>
                    <td>${fmtNum(h.odds)}</td>
                    <td style="color:${returnColor}; font-weight:bold;">${fmtMoney(grossReturn)}</td>
                    <td>${statusHtml}</td>
                    <td><button class="action-btn btn-del" onclick="deleteCoupon(${h.id})">ðŸ—‘</button></td>
                </tr>
            `;
            tbody.innerHTML += row;
        });
    }

    // --- PLAN: GEOMETRÄ°K ARTIÅž ---
    function calculateAndRenderPlan(
        cycleBalance,
        odds,
        totalSteps,
        currentStep
    ) {
        const tbody = document.getElementById("planBody");
        tbody.innerHTML = "";

        const planAmounts = buildPlan(cycleBalance, odds, totalSteps);
        if (!planAmounts) return;

        let suggestedBet = 0;

        planAmounts.forEach((amt, index) => {
            const stepNum = index + 1;
            const isCurrent = stepNum === Math.min(currentStep, totalSteps);
            if (isCurrent) suggestedBet = amt;

            const row = `
                <tr class="${isCurrent ? "current-row" : ""}">
                    <td>${stepNum}. Tur ${isCurrent ? "ðŸ‘‰" : ""}</td>
                    <td><strong>${fmtMoney(Math.floor(amt))}</strong></td>
                    <td style="color:#27ae60">${fmtMoney(
                        Math.floor(amt * odds)
                    )}</td>
                </tr>
            `;
            tbody.innerHTML += row;
        });

        const effectiveStep = Math.min(currentStep, totalSteps);

        if (effectiveStep <= totalSteps) {
            const betAmountInput = document.getElementById("betAmount");
            const betOddsInput = document.getElementById("betOdds");

            if (document.activeElement !== betAmountInput) {
                betAmountInput.value = Math.floor(
                    planAmounts[effectiveStep - 1]
                );
            }
            if (document.activeElement !== betOddsInput) {
                betOddsInput.value = odds;
            }
        }
    }

    // --- Ã–ZET ---
    function calculateSummary(currentBalance) {
        let realizedPnL = 0;
        app.history.forEach((h) => {
            if (h.status === "win")
                realizedPnL += h.amount * h.odds - h.amount;
            else if (h.status === "loss") realizedPnL -= h.amount;
        });

        const pendingTotal = app.history
            .filter((h) => h.status === "pending")
            .reduce((s, h) => s + h.amount, 0);

        const startBalance = currentBalance + pendingTotal - realizedPnL;

        let growthPercent = 0;
        if (startBalance > 0) {
            growthPercent = (realizedPnL / startBalance) * 100;
        }

        document.getElementById("sumStart").innerText =
            fmtMoney(startBalance);
        document.getElementById("sumEnd").innerText = fmtMoney(currentBalance);

        const profitEl = document.getElementById("sumProfit");
        profitEl.innerText =
            (realizedPnL > 0 ? "+" : "") + fmtMoney(realizedPnL);
        profitEl.style.color =
            realizedPnL >= 0 ? "#2ecc71" : "#e74c3c";

        const percentEl = document.getElementById("sumPercent");
        percentEl.innerText = "%" + fmtNum(growthPercent);
        percentEl.style.color =
            growthPercent >= 0 ? "#2ecc71" : "#e74c3c";
    }

    function save() {
        localStorage.setItem(
            "kasaV14_fixedMath",
            JSON.stringify(globalState)
        );
    }

    function hardReset() {
        if (!confirm("Bu kasa sÄ±fÄ±rlanacak. Emin misiniz?")) return;
        globalState.portfolios[globalState.activeIndex] = {
            history: [],
            savedInputs: null,
        };
        save();
        switchKasa(globalState.activeIndex);
    }

    // --- TAHMÄ°N: Min / Ort / Max (martingale adÄ±mlarÄ±na gÃ¶re) ---
    function updateProjection(params) {
        const {
            currentBalance,
            cycleBalance,
            odds,
            steps,
            currentStep,
            targetCoupons,
        } = params;

        const projectedEl = document.getElementById("dispProjected");

        if (!app || !app.history) {
            projectedEl.innerText = "-";
            return;
        }

        const history = app.history;
        const totalCoupons = history.length;
        const remainingCoupons = Math.max(0, targetCoupons - totalCoupons);

        if (remainingCoupons === 0) {
            projectedEl.innerText = "BÄ°TTÄ°";
            return;
        }

        const finished = history.filter((h) => h.status !== "pending");
        const wins = finished.filter((h) => h.status === "win").length;
        const losses = finished.filter((h) => h.status === "loss").length;
        const totalBets = wins + losses;

        // Ortalama kazanan oranÄ± (yoksa plan oranÄ±)
        const totalWinOdds = finished
            .filter((h) => h.status === "win")
            .reduce((sum, h) => sum + h.odds, 0);
        const avgOdds =
            wins > 0
                ? totalWinOdds / wins
                : odds > 1
                ? odds
                : 2.0;

        // Hit oranÄ± p
        let pWin;
        if (totalBets === 0) {
            pWin = 0.5; // veri yoksa nÃ¶tr varsayÄ±m
        } else {
            pWin = wins / totalBets;
        }

        // Plan tutarlarÄ±
        const planAmounts = buildPlan(cycleBalance, odds, steps);
        if (!planAmounts) {
            projectedEl.innerText = "-";
            return;
        }

        const stakeForStep = (s) =>
            planAmounts[Math.min(Math.max(s, 1), steps) - 1];

        // --- Min: tÃ¼m kalan kuponlar kaybeder ---
        let minProfit = 0;
        let sMin = Math.min(currentStep, steps);
        for (let i = 0; i < remainingCoupons; i++) {
            const stake = stakeForStep(sMin);
            minProfit -= stake;
            sMin = Math.min(sMin + 1, steps);
        }
        const minBalance = currentBalance + minProfit;

        // --- Max: tÃ¼m kalan kuponlar kazanÄ±r (her seferinde 1. adÄ±m) ---
        let maxProfit = 0;
        const stakeStep1 = stakeForStep(1);
        for (let i = 0; i < remainingCoupons; i++) {
            maxProfit += stakeStep1 * (avgOdds - 1);
        }
        const maxBalance = currentBalance + maxProfit;

        // --- Ort: tÃ¼m ihtimallerin beklenen deÄŸeri (Markov DP) ---
        let avgProfit;
        if (pWin <= 0) {
            // HiÃ§ kazanamamÄ±ÅŸsan, beklenen senaryo minimumla aynÄ±
            avgProfit = minProfit;
        } else if (pWin >= 1) {
            // Hep kazanÄ±yorsan, beklenen senaryo maksimumla aynÄ±
            avgProfit = maxProfit;
        } else {
            // f[k][s] = k kupon kala, adÄ±m s iken beklenen toplam kÃ¢r
            let fPrev = new Array(steps + 1).fill(0); // index 1..steps
            for (let k = 1; k <= remainingCoupons; k++) {
                let fCurr = new Array(steps + 1).fill(0);
                for (let s = 1; s <= steps; s++) {
                    const stake = stakeForStep(s);
                    const winProfit = stake * (avgOdds - 1) + fPrev[1];
                    const nextStepOnLoss = Math.min(s + 1, steps);
                    const lossProfit = -stake + fPrev[nextStepOnLoss];
                    fCurr[s] = pWin * winProfit + (1 - pWin) * lossProfit;
                }
                fPrev = fCurr;
            }
            const startStep = Math.min(currentStep, steps);
            avgProfit = fPrev[startStep];
        }
        const avgBalance = currentBalance + avgProfit;

        projectedEl.innerHTML =
            `Min: ${fmtMoney(minBalance)}<br>` +
            `Ort: ${fmtMoney(avgBalance)}<br>` +
            `Max: ${fmtMoney(maxBalance)}`;
    }

    // --- TÃœM KASALARI SIFIRLA ---
    function resetAllKasas() {
        if (!confirm("TÃœM kasalar sÄ±fÄ±rlanacak. Emin misiniz?")) return;
        globalState = {
            activeIndex: 0,
            portfolios: [
                { history: [], savedInputs: null },
                { history: [], savedInputs: null },
                { history: [], savedInputs: null },
            ],
        };
        save();
        switchKasa(0);
    }
</script>

</body>
</html>
